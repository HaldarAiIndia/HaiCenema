<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HaiCenema</title>

 <!-- SEO Description -->
  <meta name="description" content="HaiCenema is your home for unlimited movies, trending webseries, and ultra-fast Live TV streaming. Watch anytime, anywhere — no limits.">

<!-- Keywords (optional but useful) -->
  <meta name="keywords" content="movies, webseries, live tv, streaming, cinema, entertainment, watch movies online">

 <!-- Author -->
  <meta name="author" content="HaiCenema">

 <!-- Robots (allow indexing) -->
  <meta name="robots" content="index, follow">

  <!-- Open Graph (for social media preview) -->
  <meta property="og:title" content="HaiCenema – Stream Movies & Live TV">
  <meta property="og:description" content="Unlimited movies, webseries, and live TV streaming in one place.">
  <meta property="og:image" content="/favicon.png">
  <meta property="og:type" content="website">


<!-- Favicon -->
<link rel="icon" type="image/png" sizes="512x512" href="/favicon.png">

<!-- Apple / iOS Icon -->
<link rel="apple-touch-icon" href="/favicon.png">

<!-- Web Manifest for PWA -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#ffffff">
    
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --bg-primary: #17181a;
            --bg-secondary: #202225;
            --bg-tertiary: #2c2f33;
            --bg-hover: #35383c;
            --text-primary: #f0f2f5;
            --text-secondary: #a8b3cf;
            --text-active: #82aaff;
            --border-color: #3a3d42;
            --sidebar-width: 260px;
            --font-family: 'Inter', sans-serif;
            --primary: #6d28d9;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; background-color: var(--bg-primary); color: var(--text-primary); font-family: var(--font-family); font-size: 16px; }
        button, a { background: none; border: none; cursor: pointer; color: inherit; text-decoration: none; font-family: inherit; }
        .material-symbols-outlined { font-size: 24px; color: var(--text-secondary); transition: color 0.2s, font-variation-settings 0.2s; user-select: none; }
        *:focus-visible { outline: 2px solid var(--text-active); outline-offset: 2px; border-radius: 4px; }
        
        .app-container { display: flex; width: 100%; height: 100%; }
        .main-wrapper { width: 100%; height: 100%; display: flex; flex-direction: column; }
        .main-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 24px; background-color: rgba(23, 24, 26, 0.7); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-color); flex-shrink: 0; position: sticky; top: 0; z-index: 100; transition: transform 0.3s ease; }
        .header-left { display: flex; align-items: center; gap: 1rem; flex-grow: 1; }
        .icon-button { padding: 8px; border-radius: 50%; display: flex; transition: background-color 0.2s; }
        .icon-button:hover { background-color: var(--bg-hover); }
        .content-area { flex-grow: 1; overflow: hidden; position: relative; transition: opacity 0.3s ease; }
        
        #left-sidebar { position: fixed; top: 0; left: 0; height: 100%; width: var(--sidebar-width); max-width: 85%; background-color: var(--bg-secondary); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: 1001; transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
        body.left-sidebar-open #left-sidebar { transform: translateX(0); }
        .sidebar-content { padding: 16px; display: flex; flex-direction: column; flex-grow: 1; overflow-y: auto; }
        .sidebar-header { font-size: 1.75rem; font-weight: 700; padding: 12px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px; }
        .sidebar-nav { flex-grow: 1; }
        .sidebar-nav a { font-size: 1em; display: flex; align-items: center; gap: 16px; padding: 12px; border-radius: 8px; font-weight: 500; transition: background-color 0.2s, color 0.2s; color: var(--text-secondary); }
        .sidebar-nav a:hover { background-color: var(--bg-hover); color: var(--text-primary); }
        .sidebar-nav a.active { background-color: var(--bg-tertiary); color: var(--text-primary); }
        
        .screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; }
        .screen.active { display: block; }
        .content-wrapper { max-width: 1200px; width: 100%; margin: 0 auto; padding: 24px; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000; }
        body.left-sidebar-open .overlay { opacity: 1; visibility: visible; }
        
        @media (min-width: 1024px) {
            #left-sidebar { position: static; transform: none; }
            .icon-button#menu-toggle { display: none; }
            .main-wrapper { width: calc(100% - var(--sidebar-width)); }
        }

        .horizontal-scroll { display: flex; overflow-x: auto; padding-bottom: 1rem; scrollbar-width: none; -ms-overflow-style: none;}
        .horizontal-scroll::-webkit-scrollbar { display: none; }
        
        .item-card { display: block; flex-shrink: 0; width: 160px; margin-right: 16px; }
        .item-card-image-container { position: relative; aspect-ratio: 2 / 3; border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color); transition: border-color 0.2s, transform 0.2s; }
        body:not(.touch-device) .item-card:hover .item-card-image-container { border-color: var(--text-active); transform: translateY(-4px); }
        .item-card-image { width: 100%; height: 100%; object-cover; }
        .item-card-label { position: absolute; bottom: 0; left: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); font-size: 0.75rem; padding: 2px 8px; border-top-right-radius: 8px; }
        .item-card-title { font-size: 0.9rem; margin-top: 8px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }
        
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px; }

        .banner-wrapper { overflow: hidden; }
        .banner-container { width: 200%; display: flex; animation: scroll 30s linear infinite; }
        .banner-item { width: 50%; flex-shrink: 0; padding: 0 8px; }
        @media (min-width: 768px) { .banner-item { width: 33.333%; } }
        @media (min-width: 1024px) { .banner-item { width: 25%; } }
        .banner-item img { width: 100%; aspect-ratio: 16 / 7; object-cover; border-radius: 12px; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

        #search-input-container { flex-grow: 1; max-width: 500px; transition: opacity 0.2s ease, visibility 0.2s; }
        #search-input { width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 16px; color: var(--text-primary); font-size: 1rem; outline: none; transition: border-color 0.2s; }
        #search-input:focus { border-color: var(--text-active); }
        
        .liked-icon { fill: var(--primary); color: var(--primary); }

        .skeleton {
            background-color: var(--bg-tertiary);
            position: relative;
            overflow: hidden;
        }
        .skeleton::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transform: translateX(-100%);
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.08), transparent);
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }
    </style>
</head>
<body>
    <script src="https://cdn.tailwindcss.com"></script>

    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside id="left-sidebar">
            <div class="sidebar-content">
                <header class="sidebar-header">
                    <img src="/favicon.png" alt="Logo" class="h-8">
                </header>
                <nav class="sidebar-nav">
                    <a href="#movies" class="nav-item active" data-section="movies"><span class="material-symbols-outlined">movie</span>Movies</a>
                    <a href="#series" class="nav-item" data-section="series"><span class="material-symbols-outlined">live_tv</span>Series</a>
                    <a href="#livetv" class="nav-item" data-section="livetv"><span class="material-symbols-outlined">satellite_alt</span>Live TV</a>
                    <a href="#" class="nav-item" onclick="event.preventDefault(); window.open('https://HaiCenema.vercel.app/review', '_blank');"><span class="material-symbols-outlined">rate_review</span>Review</a>
                </nav>
            </div>
        </aside>

        <!-- Main Content Wrapper -->
        <div class="main-wrapper">
            <header class="main-header">
                <div class="header-left">
                    <button id="menu-toggle" class="icon-button"><span class="material-symbols-outlined">menu</span></button>
                    <div id="search-input-container" class="invisible opacity-0"><input type="search" id="search-input" placeholder="Search across all content..."></div>
                </div>
                <button id="search-toggle" class="icon-button"><span class="material-symbols-outlined">search</span></button>
            </header>

            <main class="content-area">
                <div id="movies-screen" class="screen active"><div class="content-wrapper" id="movies-content"></div></div>
                <div id="series-screen" class="screen"><div class="content-wrapper" id="series-content-wrapper"></div></div>
                <div id="livetv-screen" class="screen"><div class="content-wrapper" id="livetv-content"></div></div>
                <div id="search-screen" class="screen"><div class="content-wrapper" id="search-content"></div></div>
            </main>
        </div>
    </div>
    
    <div id="player-view" class="fixed inset-0 bg-bg-primary z-[60] flex-col hidden transition-opacity duration-300 opacity-0">
         <div class="w-full bg-black">
            <div class="relative max-w-7xl mx-auto">
                <div class="relative w-full aspect-video">
                    <button id="close-player-btn" class="absolute top-4 left-4 z-10 p-2 bg-black bg-opacity-50 rounded-full text-white hover:bg-opacity-70">
                        <i data-lucide="arrow-left" class="w-6 h-6"></i>
                    </button>
                    <video id="video-player" controls controlslist="nodownload" class="w-full h-full object-contain"></video>
                </div>
             </div>
         </div>
         <div class="flex-grow p-4 overflow-y-auto">
             <div class="max-w-7xl mx-auto">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                    <h2 id="player-title" class="text-2xl font-bold mb-2 text-text-primary">Title</h2>
                    <div class="flex items-center space-x-4 mt-2 sm:mt-0">
                        <div class="flex items-center space-x-1 text-text-secondary">
                            <i data-lucide="eye" class="w-5 h-5"></i>
                            <span id="player-views">0</span>
                        </div>
                        <button id="like-btn" class="flex items-center space-x-2 py-2 px-3 rounded-lg bg-bg-secondary hover:bg-bg-tertiary transition-colors">
                            <i id="like-icon" data-lucide="thumbs-up" class="w-5 h-5 text-text-secondary"></i>
                            <span id="like-count" class="text-text-secondary">0</span>
                        </button>
                    </div>
                </div>
                
                <div id="related-content-container" class="mt-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xl font-semibold">Related</h3>
                        <div class="flex items-center space-x-2">
                            <label for="autoplay-toggle-input" class="text-sm text-text-secondary cursor-pointer">Autoplay</label>
                            <button id="autoplay-toggle" role="switch" aria-checked="false" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-bg-tertiary transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-bg-primary">
                                <span id="autoplay-indicator" class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-0"></span>
                            </button>
                        </div>
                    </div>
                    <div id="related-content" class="horizontal-scroll"></div>
                </div>
            </div>
         </div>
    </div>
    
    <div id="overlay" class="overlay"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, getDocs, onSnapshot, updateDoc, increment, query, where, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDwH5hg4QRYcTzyPd492L9g2xG3QPvCWMY",
  authDomain: "haicenema.firebaseapp.com",
  databaseURL: "https://haicenema-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "haicenema",
  storageBucket: "haicenema.firebasestorage.app",
  messagingSenderId: "825485404342",
  appId: "1:825485404342:web:c488be2082a9b30c3cde17",
  measurementId: "G-9YG52515FX"
};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const MOCK_USER_ID = "mock-user-123";

        let currentSection = 'movies';
        let isSearchActive = false;
        let currentPlaying = null;
        let unsubscribeFromLikes = null;
        let isAutoplayEnabled = false;

        const ui = {
            mainHeader: document.querySelector('.main-header'),
            contentArea: document.querySelector('.content-area'),
            menuToggle: document.getElementById('menu-toggle'),
            overlay: document.getElementById('overlay'),
            navItems: document.querySelectorAll('.nav-item'),
            screens: document.querySelectorAll('.screen'),
            searchToggle: document.getElementById('search-toggle'),
            searchInputContainer: document.getElementById('search-input-container'),
            searchInput: document.getElementById('search-input'),
            playerView: document.getElementById('player-view'),
            closePlayerBtn: document.getElementById('close-player-btn'),
            videoPlayer: document.getElementById('video-player'),
            playerTitle: document.getElementById('player-title'),
            playerViews: document.getElementById('player-views'),
            likeBtn: document.getElementById('like-btn'),
            likeIcon: document.getElementById('like-icon'),
            likeCount: document.getElementById('like-count'),
            relatedContentContainer: document.getElementById('related-content-container'),
            relatedContent: document.getElementById('related-content'),
            autoplayToggle: document.getElementById('autoplay-toggle'),
            autoplayIndicator: document.getElementById('autoplay-indicator'),
        };

        const createSkeletonCard = () => `
            <div class="item-card">
                <div class="skeleton item-card-image-container"></div>
                <div class="skeleton h-4 w-3/4 mx-auto mt-2 rounded"></div>
            </div>
        `;

        const createSkeletonGrid = (count = 12) => `<div class="grid-view">${Array(count).fill(createSkeletonCard()).join('')}</div>`;
        
        const createSkeletonCarousel = (count = 6) => `
            <div class="mb-8">
                <div class="skeleton h-6 w-1/3 mb-4 rounded"></div>
                <div class="horizontal-scroll">${Array(count).fill(createSkeletonCard()).join('')}</div>
            </div>
        `;
        
        const moviesSkeletonHTML = `
            <div class="skeleton w-full aspect-[16/7] rounded-lg mb-8"></div>
            ${createSkeletonCarousel()}
            ${createSkeletonCarousel()}
        `;

        const relatedSkeletonHTML = `<div class="horizontal-scroll">${Array(6).fill(createSkeletonCard()).join('')}</div>`;

        // --- BUG FIX IS HERE ---
        function renderEpisodeCard(episode, index, seriesData) {
            return `
            <div class="item-card cursor-pointer group" data-id="${seriesData.id}" data-type="series" data-episode-index="${index}">
                 <!-- FIX: Changed aspect-video to aspect-[2/3] for a portrait view -->
                 <div class="relative w-full aspect-[2/3] rounded-lg overflow-hidden shadow-lg group-hover:ring-2 ring-primary transition-shadow bg-bg-tertiary">
                     <img src="${episode.imageUrl || seriesData.imageUrl}" alt="Episode ${index+1}" class="w-full h-full object-cover">
                     <span class="absolute top-2 right-2 bg-primary text-xs text-white px-2 py-0.5 rounded-full">E${index+1}</span>
                 </div>
                 <h4 class="item-card-title">Episode ${index+1}</h4>
            </div>
            `;
        }

        function renderItemCard(item, type) {
             const label = type === 'movies' ? item.catalogue : type === 'series' ? 'Series' : 'Live TV';
             return `
             <div class="item-card cursor-pointer" data-id="${item.id}" data-type="${type}">
                 <div class="item-card-image-container"><img src="${item.imageUrl}" alt="${item.name}" class="item-card-image">
                     <span class="item-card-label">${label}</span>
                 </div>
                 <h4 class="item-card-title">${item.name}</h4>
             </div>`;
        }
        
        async function renderMovies() {
            const container = document.getElementById('movies-content');
            container.innerHTML = moviesSkeletonHTML;
            const [bannersSnapshot, moviesSnapshot] = await Promise.all([ getDocs(collection(db, 'banners')), getDocs(query(collection(db, 'movies'), where("isPublic", "==", true))) ]);
            const banners = bannersSnapshot.docs.map(doc => doc.data());
            const movies = moviesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const moviesByCategory = movies.reduce((acc, movie) => {
                const category = movie.catalogue || 'Other';
                if (!acc[category]) acc[category] = [];
                acc[category].push(movie);
                return acc;
            }, {});

            container.innerHTML = `
                <div class="banner-wrapper mb-8"><div class="banner-container">
                    ${[...banners, ...banners].map(banner => `<div class="banner-item"><img src="${banner.url}"></div>`).join('')}
                </div></div>
                ${Object.keys(moviesByCategory).map(category => `
                    <div class="mb-8"><h2 class="text-2xl font-bold mb-4">${category}</h2>
                        <div class="horizontal-scroll">${moviesByCategory[category].map(movie => renderItemCard(movie, 'movies')).join('')}</div>
                    </div>
                `).join('') || '<p class="text-text-secondary">No movies available at the moment.</p>'}
            `;
            addClickListeners(container);
        }

        async function renderSeries(seriesId = null) {
            const wrapper = document.getElementById('series-content-wrapper');
            wrapper.innerHTML = createSkeletonGrid();

            if (seriesId) {
                const seriesDoc = await getDoc(doc(db, 'series', seriesId));
                if (!seriesDoc.exists()) { wrapper.innerHTML = 'Series not found.'; return; }
                const seriesData = { id: seriesDoc.id, ...seriesDoc.data() };
                wrapper.innerHTML = `
                    <button id="back-to-series" class="flex items-center gap-2 mb-6 font-semibold text-text-secondary hover:text-text-primary"><span class="material-symbols-outlined">arrow_back</span> Back to Series List</button>
                    <div class="page-header"><h2>${seriesData.name} - Episodes</h2></div>
                    <div class="grid-view">
                        ${seriesData.episodes.map((ep, idx) => renderEpisodeCard(ep, idx, seriesData)).join('')}
                    </div>
                `;
                document.getElementById('back-to-series').addEventListener('click', () => renderSeries());
            } else {
                const seriesSnapshot = await getDocs(query(collection(db, 'series'), where("isPublic", "==", true)));
                const series = seriesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                wrapper.innerHTML = `<div class="grid-view">${series.map(s => renderItemCard(s, 'series')).join('') || '<p class="text-text-secondary">No series available.</p>'}</div>`;
            }
            addClickListeners(wrapper);
        }

        async function renderLiveTV() {
            const container = document.getElementById('livetv-content');
            container.innerHTML = createSkeletonGrid();
            const liveTVSnapshot = await getDocs(query(collection(db, 'livetv'), where("isPublic", "==", true)));
            const channels = liveTVSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            container.innerHTML = `<div class="grid-view">${channels.map(c => renderItemCard(c, 'livetv')).join('') || '<p class="text-text-secondary">No channels available.</p>'}</div>`;
            addClickListeners(container);
        }

        async function renderSearch(searchTerm) {
             const container = document.getElementById('search-content');
             if (searchTerm.length < 2) { container.innerHTML = `<p class="text-center text-text-secondary mt-10">Type at least 2 characters to search.</p>`; return; }
             container.innerHTML = createSkeletonGrid();

             const [movieSnapshot, seriesSnapshot, liveTvSnapshot] = await Promise.all([ getDocs(collection(db, 'movies')), getDocs(collection(db, 'series')), getDocs(collection(db, 'livetv')) ]);
             const normalizedTerm = searchTerm.toLowerCase();
             const filter = (doc) => doc.data().isPublic && doc.data().name.toLowerCase().includes(normalizedTerm);
             const results = {
                movies: movieSnapshot.docs.filter(filter).map(doc => ({id: doc.id, ...doc.data()})),
                series: seriesSnapshot.docs.filter(filter).map(doc => ({id: doc.id, ...doc.data()})),
                livetv: liveTvSnapshot.docs.filter(filter).map(doc => ({id: doc.id, ...doc.data()})),
             };
            
             let html = '';
             if(results.movies.length) html += `<div class="mb-8"><h2 class="text-2xl font-bold mb-4">Movies</h2><div class="grid-view">${results.movies.map(m => renderItemCard(m, 'movies')).join('')}</div></div>`;
             if(results.series.length) html += `<div class="mb-8"><h2 class="text-2xl font-bold mb-4">Series</h2><div class="grid-view">${results.series.map(s => renderItemCard(s, 'series')).join('')}</div></div>`;
             if(results.livetv.length) html += `<div class="mb-8"><h2 class="text-2xl font-bold mb-4">Live TV</h2><div class="grid-view">${results.livetv.map(c => renderItemCard(c, 'livetv')).join('')}</div></div>`;
             
             container.innerHTML = html || `<p class="text-center text-text-secondary mt-10">No results found for "${searchTerm}".</p>`;
             addClickListeners(container);
        }
        
        function addClickListeners(container) {
            const scope = container || document;
            scope.querySelectorAll('.item-card').forEach(card => {
                card.addEventListener('click', async () => {
                    const id = card.dataset.id;
                    const type = card.dataset.type;
                    if (type === 'series' && !card.dataset.episodeIndex) { renderSeries(id); return; }
                    
                    const itemDoc = await getDoc(doc(db, type, id));
                    if (!itemDoc.exists()) return;
                    
                    const itemData = { id: itemDoc.id, ...itemDoc.data() };
                    const playerData = { item: itemData, type, collection: type };
                    
                    if (type === 'series') {
                        const episodeIndex = parseInt(card.dataset.episodeIndex);
                        playerData.episode = itemData.episodes?.[episodeIndex];
                        playerData.episodeIndex = episodeIndex;
                        playerData.item.name = `${itemData.name} - Episode ${episodeIndex + 1}`;
                    }

                    const videoUrl = playerData.type === 'series' ? playerData.episode?.url : playerData.item.movieUrl || playerData.item.liveTvUrl;
                    if (!videoUrl) {
                        alert("Sorry, the video source for this item could not be found.");
                        return;
                    }
                    
                    togglePlayerView(true, playerData);
                });
            });
        }
        
        function switchSection(section) {
            currentSection = section;
            if (isSearchActive && section !== 'search') toggleSearch(false);
            const activeLink = document.querySelector(`.nav-item[data-section="${section}"]`);
            if (activeLink) {
                 ui.navItems.forEach(item => item.classList.remove('active'));
                 activeLink.classList.add('active');
            }
            ui.screens.forEach(s => s.classList.remove('active'));
            document.getElementById(`${section}-screen`).classList.add('active');
            if (section === 'movies') renderMovies();
            else if (section === 'series') renderSeries();
            else if (section === 'livetv') renderLiveTV();
            document.body.classList.remove('left-sidebar-open');
        }

        function toggleSearch(forceState) {
            const becomingActive = forceState !== undefined ? forceState : !isSearchActive;
            isSearchActive = becomingActive;
            ui.searchInputContainer.classList.toggle('invisible', !becomingActive);
            ui.searchInputContainer.classList.toggle('opacity-0', !becomingActive);
            if (becomingActive) { ui.searchInput.focus(); switchSection('search'); } 
            else { ui.searchInput.value = ''; if (currentSection === 'search') switchSection('movies'); }
        }
        
        function togglePlayerView(show, data = null) {
            if (show) {
                ui.mainHeader.style.transform = 'translateY(-100%)';
                ui.contentArea.style.opacity = '0';
                
                ui.playerView.classList.remove('hidden');
                ui.playerView.classList.add('flex');
                setTimeout(() => ui.playerView.classList.remove('opacity-0'), 10);
                
                if(data) updatePlayer(data);
            } else {
                ui.videoPlayer.pause();
                ui.videoPlayer.src = "";
                if (unsubscribeFromLikes) unsubscribeFromLikes();
                
                ui.playerView.classList.add('opacity-0');
                setTimeout(() => {
                    ui.playerView.classList.add('hidden');
                    ui.playerView.classList.remove('flex');
                    ui.mainHeader.style.transform = 'translateY(0)';
                    ui.contentArea.style.opacity = '1';
                }, 300);
            }
        }
        
        async function updatePlayer(data) {
            currentPlaying = data;
            
            ui.playerTitle.textContent = data.item.name;
            const videoUrl = data.type === 'series' ? data.episode.url : data.item.movieUrl || data.item.liveTvUrl;
            ui.videoPlayer.src = videoUrl;
            ui.videoPlayer.play().catch(e => console.error("Autoplay prevented.", e));

            const itemRef = doc(db, data.collection, data.item.id);
            await updateDoc(itemRef, { views: increment(1) });
            
            unsubscribeFromLikes = onSnapshot(itemRef, (docSnap) => {
                if(docSnap.exists()){
                    const d = docSnap.data();
                    const likes = d.likes || [];
                    ui.playerViews.textContent = d.views || 0;
                    ui.likeCount.textContent = likes.length;
                    
                    if (likes.includes(MOCK_USER_ID)) {
                        ui.likeIcon.classList.add('liked-icon');
                    } else {
                        ui.likeIcon.classList.remove('liked-icon');
                    }
                }
            });
            renderRelatedContent(data);
        }

        async function handleLikeToggle() {
            if (!currentPlaying) return;
            const itemRef = doc(db, currentPlaying.collection, currentPlaying.item.id);
            const docSnap = await getDoc(itemRef);
            if (docSnap.exists()) {
                const likes = docSnap.data().likes || [];
                const isLiked = likes.includes(MOCK_USER_ID);
                await updateDoc(itemRef, { 
                    likes: isLiked ? arrayRemove(MOCK_USER_ID) : arrayUnion(MOCK_USER_ID) 
                });
            }
        }

        async function renderRelatedContent(data) {
            ui.relatedContent.innerHTML = relatedSkeletonHTML;
            let html = '';
            if (data.type === 'movies') {
                const q = query(collection(db, 'movies'), where("catalogue", "==", data.item.catalogue), where("isPublic", "==", true));
                const snapshot = await getDocs(q);
                const related = snapshot.docs.map(d => ({id: d.id, ...d.data()})).filter(m => m.id !== data.item.id);
                html = related.map(m => renderItemCard(m, 'movies')).join('');
                ui.relatedContentContainer.querySelector('h3').textContent = "More from " + data.item.catalogue;
            } else if (data.type === 'series') {
                html = data.item.episodes.map((ep, idx) => renderEpisodeCard(ep, idx, data.item)).join('');
                ui.relatedContentContainer.querySelector('h3').textContent = "All Episodes";
            } else {
                const q = query(collection(db, 'livetv'), where("isPublic", "==", true));
                const snapshot = await getDocs(q);
                const related = snapshot.docs.map(d => ({id: d.id, ...d.data()})).filter(c => c.id !== data.item.id);
                html = related.map(c => renderItemCard(c, 'livetv')).join('');
                ui.relatedContentContainer.querySelector('h3').textContent = "Other Channels";
            }
            ui.relatedContent.innerHTML = html || '<p class="text-text-secondary">No related content found.</p>';
            addClickListeners(ui.relatedContent);
            lucide.createIcons();
        }

        ui.menuToggle.addEventListener('click', () => document.body.classList.add('left-sidebar-open'));
        ui.overlay.addEventListener('click', () => document.body.classList.remove('left-sidebar-open'));
        ui.navItems.forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); switchSection(item.dataset.section); }));
        ui.searchToggle.addEventListener('click', () => toggleSearch());
        ui.searchInput.addEventListener('input', (e) => renderSearch(e.target.value));
        
        ui.closePlayerBtn.addEventListener('click', () => togglePlayerView(false));
        ui.likeBtn.addEventListener('click', handleLikeToggle);
        
        ui.autoplayToggle.addEventListener('click', () => {
            isAutoplayEnabled = !isAutoplayEnabled;
            if (isAutoplayEnabled) {
                ui.autoplayToggle.setAttribute('aria-checked', 'true');
                ui.autoplayToggle.classList.replace('bg-bg-tertiary', 'bg-primary');
                ui.autoplayIndicator.classList.replace('translate-x-0', 'translate-x-5');
            } else {
                ui.autoplayToggle.setAttribute('aria-checked', 'false');
                ui.autoplayToggle.classList.replace('bg-primary', 'bg-bg-tertiary');
                ui.autoplayIndicator.classList.replace('translate-x-5', 'translate-x-0');
            }
        });

        ui.videoPlayer.addEventListener('ended', () => {
            if (!isAutoplayEnabled || !currentPlaying) return;
            
            let nextItemCard;
            if (currentPlaying.type === 'series' && currentPlaying.episodeIndex !== undefined) {
                const nextEpisodeIndex = currentPlaying.episodeIndex + 1;
                nextItemCard = ui.relatedContent.querySelector(`.item-card[data-episode-index="${nextEpisodeIndex}"]`);
            } else {
                nextItemCard = ui.relatedContent.querySelector('.item-card');
            }

            if (nextItemCard) {
                nextItemCard.click();
            }
        });
        
        lucide.createIcons();
        switchSection('movies');
    </script>
</body>
</html>
